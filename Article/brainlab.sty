% brainlab.sty -- пакет оформления BRAIn Lab

\NeedsTeXFormat{LaTeX2e}
\ProvidesExplPackage
  {brainlab}
  {2025/06/02}
  {0.2}
  {BRAIn Lab formatting package}

\RequirePackage{xcolor}
\RequirePackage{xkeyval}
\RequirePackage{etoolbox}
\RequirePackage{expl3}
\RequirePackage{l3keys2e}
\RequirePackage{xparse}
\RequirePackage{xstring}
\RequirePackage{physics}
\RequirePackage{shortcuts}

% ========== Опции пакета ============
\definecolor{braincolor}{RGB}{190,32,240} % default brain color
\definecolor{graybg}{RGB}{245,245,250}    % default bg color

\newif\if@linkcolorset
\newif\if@citecolorset
\newif\if@urlcolorset

\newif\iftwocolumnmode
\twocolumnmodefalse

\newif\ifshownumpages
\shownumpagesfalse

\def\bibliostyle{plainnat}
\def\bibfile{references}
\def\citingstyle{authoryear}

\DeclareOptionX{twocolumnmode}{\twocolumnmodetrue}
\DeclareOptionX{shownumpages}{\shownumpagestrue}

\DeclareOptionX{bgcolor}{
  \IfSubStr{#1}{,}
    {\definecolor{graybg}{RGB}{#1}}
    {\colorlet{graybg}{#1}}
}

\DeclareOptionX{braincolor}{
  \IfSubStr{#1}{,}
    {\definecolor{braincolor}{RGB}{#1}}
    {\colorlet{braincolor}{#1}}
}

\DeclareOptionX{linkcolor}{
  \IfSubStr{#1}{,}
    {\definecolor{linkcolor}{RGB}{#1}}
    {\colorlet{linkcolor}{#1}}\@linkcolorsettrue
}

\DeclareOptionX{citecolor}{
  \IfSubStr{#1}{,}
    {\definecolor{citecolor}{RGB}{#1}}
    {\colorlet{citecolor}{#1}}\@citecolorsettrue
}

\DeclareOptionX{urlcolor}{
  \IfSubStr{#1}{,}
    {\definecolor{urlcolor}{RGB}{#1}}
    {\colorlet{urlcolor}{#1}}\@urlcolorsettrue
}
\DeclareOptionX{citingstyle}{\def\citingstyle{#1}}
\DeclareOptionX{bibliostyle}{\def\bibliostyle{#1}}
\DeclareOptionX{bibfile}{\def\bibfile{#1}}

\ProcessOptionsX\relax

% fallback to braincolor if not explicitly set
\if@linkcolorset\else\colorlet{linkcolor}{braincolor}\fi
\if@citecolorset\else\colorlet{citecolor}{braincolor}\fi
\if@urlcolorset\else\colorlet{urlcolor}{blue}\fi

% ========== Базовые подключения ===========
\RequirePackage{inputenc}
\RequirePackage[T2A]{fontenc}
\RequirePackage[english]{babel}
\RequirePackage{lipsum}
\RequirePackage[top=0.8in, bottom=0.8in, left=0.5in, right=0.5in]{geometry}
\RequirePackage{multicol}
\RequirePackage{titlesec}
\RequirePackage[hypcap=false]{caption}
\RequirePackage{fancyhdr}
\RequirePackage{authblk}
\RequirePackage{amsmath, amssymb, amsthm}
\RequirePackage{graphicx, float}
\RequirePackage{array, booktabs, colortbl}
\RequirePackage{algorithm, algpseudocode}
\PassOptionsToPackage{square,\citingstyle}{natbib}
\RequirePackage{natbib}
\let\cite\citep
\RequirePackage[
  colorlinks=true,
  citecolor=citecolor,
  linkcolor=linkcolor,
  urlcolor=urlcolor
]{hyperref}
\RequirePackage[noabbrev]{cleveref}
\crefname{equation}{}{}
\Crefname{equation}{}{}
\RequirePackage[most]{tcolorbox}
\RequirePackage{csvsimple}

% ========== Глобальные настройки ===========
\ifshownumpages
  \pagestyle{fancy}
  \fancyhf{}
  \fancyfoot[C]{\thepage}
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0pt}
\else
  \pagestyle{empty}
\fi
\titleformat{\section}{\large\bfseries\color{black}}{\thesection}{1em}{}
\setlength{\parindent}{0pt}
\captionsetup[table]{labelfont=bf, labelsep=colon, font=small}

% ========== Meta-информация ===========
\providecommand{\papertitle}{}
\providecommand{\brainauthors}{}
\providecommand{\affils}{}
\providecommand{\abstracttext}{}
\providecommand{\additionallogoslist}{}

\newif\ifshowadditionallogos
\showadditionallogosfalse

\ExplSyntaxOn
\NewDocumentCommand{\setbrainmeta}{m}{
  \keys_set:nn { brain / meta } { #1 }
}

\keys_define:nn { brain / meta }
  {
    title      .code:n = { \renewcommand{\papertitle}{#1} },
    authors    .code:n = { \renewcommand{\brainauthors}{#1} },
    affiliations .code:n = { \renewcommand{\affils}{#1} },
    abstract   .code:n = { \renewcommand{\abstracttext}{#1} },
    additionallogos .code:n = { \renewcommand{\additionallogoslist}{#1}\showadditionallogostrue },
  }
\ExplSyntaxOff

% ========== Оформление блоков ===========
\newtcolorbox{braintitlebox}{
  colback=graybg,
  colframe=gray!60,
  arc=2mm,
  boxrule=0.3pt,
  width=\textwidth,
  left=12pt, right=12pt, top=10pt, bottom=10pt,
  enhanced,
}

\newtcolorbox{braintablebox}[1][]{
  colback=graybg,
  colframe=gray!60,
  arc=2mm,
  boxrule=0.3pt,
  width=\columnwidth,
  left=10pt, right=10pt, top=8pt, bottom=8pt,
  enhanced,
  #1
}

\let\oldtable\table
\let\endoldtable\endtable

\RenewDocumentEnvironment{table}{O{}}
{
  \oldtable[#1]
  \begin{braintablebox}
}
{
  \end{braintablebox}
  \endoldtable
}

\RenewDocumentEnvironment{table*}{O{}}
{
  \makeatletter\@dblfloat{table}[#1]\makeatother
  \begin{braintablebox}[width=\textwidth]
}
{
  \end{braintablebox}
  \makeatletter\end@dblfloat\makeatother
}

\renewenvironment{algorithm}[2][]{%
  \refstepcounter{algorithm}%
  \begin{tcolorbox}[%
    colback=graybg,
    colframe=gray!60,
    arc=2mm,
    boxrule=0.3pt,
    width=\columnwidth,
    left=10pt, right=10pt, top=8pt, bottom=8pt,
    enhanced,
    title={\textbf{Algorithm~\thealgorithm}: #2},%
    fonttitle=\bfseries,
    coltitle=black,
    attach boxed title to top left={yshift=-2mm, xshift=4mm},%
    boxed title style={colback=graybg, sharp corners, colframe=braincolor!40},%
    #1
  ]
}{%
  \end{tcolorbox}%
}

\newcommand{\highlightrow}{\rowcolor{braincolor!15}}
\newcommand{\highlightcell}{\cellcolor{braincolor!15}}

\tcbset{brainstyle/.style={
  colback=graybg,
  colframe=gray!60,
  arc=2mm,
  boxrule=0.3pt,
  width=\columnwidth,
  left=12pt, right=12pt, top=10pt, bottom=10pt,
  enhanced,
  attach boxed title to top left={yshift=-2mm, xshift=4mm},
  boxed title style={colback=graybg, sharp corners, colframe=braincolor!40},
  fonttitle=\bfseries,
  coltitle=black
}}

\ExplSyntaxOn
\NewDocumentCommand{\DeclareBrainTcbTheorem}{mm}{
  \newtheorem{#1}{#2}
  \RenewDocumentEnvironment{#1}{o +b}
   {
    \refstepcounter{#1}
    \begin{tcolorbox}[
      brainstyle,
      title={\textbf{#2~\csname the#1\endcsname}\IfValueT{##1}{\ (\textit{##1})}},
    ]
    ##2
    \end{tcolorbox}
   }
   {}
}
\ExplSyntaxOff

\DeclareBrainTcbTheorem{theorem}{Theorem}
\DeclareBrainTcbTheorem{assumption}{Assumption}
\DeclareBrainTcbTheorem{definition}{Definition}

% ========== Рендеринг ============
\newcommand{\additionallogos}[1]{%
  \\[0.7em]
  \begin{minipage}[t]{0.9\columnwidth}
    \renewcommand{\do}[1]{\includegraphics[height=1.2em]{logos/##1}\hspace{1.5em}}%
    \expandafter\docsvlist\expandafter{#1}%
  \end{minipage}%
} 

\newcommand{\maketitlebox}{%
  \begin{center}
  \begin{braintitlebox}
  \begin{minipage}[t]{0.75\textwidth}
    \includegraphics[height=1.5em]{logos/mipt.png}\hspace{1.5em}
    \includegraphics[height=1.5em]{logos/isp.png}\hspace{1.5em}
    \includegraphics[height=1.5em]{logos/innopolis.png}
  \end{minipage}%
  \hfill
  \begin{minipage}[t]{0.25\textwidth}
    \raggedleft
    \raisebox{.21em}{\textbf{\Large \textcolor{braincolor}{BRAIn Lab}}} \hspace{.5em}
    \includegraphics[height=1.5em]{logos/brain.png}
  \end{minipage}%
  \ifshowadditionallogos
    \additionallogos{\additionallogoslist}
  \fi%
  \\[1.2em]
  \begin{minipage}[t]{\textwidth}
    {\LARGE \textbf{\papertitle}} \\[1.2em]
    \textbf{\brainauthors} \\[0.3em]
    \affils
  \end{minipage}

  \vspace{1.3em}

  \abstracttext

  \end{braintitlebox}
  \end{center}
  \vspace{1.5em}
}

\NewDocumentEnvironment{mainpart}{}
{
  \iftwocolumnmode \twocolumn[\maketitlebox] \else \maketitlebox \fi
}
{
  \bibliographystyle{\bibliostyle}
  \bibliography{\bibfile}
  \iftwocolumnmode \onecolumn \fi
}

\NewDocumentEnvironment{appendixpart}{}
{
  \clearpage
  \appendix
  \begin{tcolorbox}[
    colback=graybg,
    colframe=gray!60,
    width=\columnwidth,
    arc=2mm,
    boxrule=0.3pt,
    left=10pt, right=10pt, top=6pt, bottom=6pt,
    enhanced,
  ]
  \centering
  \textbf{\Large Appendix} \\
  {\small Supplementary Materials for \textit{\papertitle}}
  \end{tcolorbox}
  \vspace{1em}
  % \iftwocolumnmode \begin{multicols}{2} \fi
}
{
  % \iftwocolumnmode \end{multicols} \fi
}
